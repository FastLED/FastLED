[env]
; Global settings for all environments
; NOTE: build_cache_enable and build_cache_dir are not standard PlatformIO options
; Board-specific cache directories are now configured per-board in ci/ci/boards.py
;build_cache_enable = true
;build_cache_dir = ${platformio.build_cache_dir}
; ccache_config.py disabled - ccache not available on this system
;extra_scripts =
;    pre:ci/util/ccache_config.py

[env:generic-esp]
# Developement branch of the open source espressif32 platform
platform = https://github.com/pioarduino/platform-espressif32/releases/download/55.03.35/platform-espressif32.zip
framework = arduino
upload_protocol = esptool
monitor_filters = 
	default
	esp32_exception_decoder  ; Decode exceptions so that they are human readable.
; Symlink in the FastLED library so that changes to the library are reflected in the project
; build immediatly.
lib_deps = 
  FastLED=symlink://./
build_type = debug

build_flags =
    -DDEBUG
    -DPIN_CLOCK=7
    -DFASTLED_RMT5=1
    -DESP32_ARDUINO_NO_RGB_BUILTIN=1
    ; -DFASTLED_LOG_RMT_ENABLED
    ; -DFASTLED_LOG_PARLIO_ENABLED
    -DFASTLED_DEBUG=1
    -g
    -Og
    -DCORE_DEBUG_LEVEL=5
    -DLOG_LOCAL_LEVEL=ESP_LOG_VERBOSE
    -DFASTLED_ESP32_SPI_BULK_TRANSFER=1
    -D IDF_CCACHE_ENABLE=1
    -DFASTLED_DEBUG_STACK_TRACE
check_tool = clangtidy

[env:uno]
platform = atmelavr
board = uno
framework = arduino

[env:giga_r1_m7]
platform = ststm32
board = giga_r1_m7
framework = arduino

[env:esp32s3]
extends = env:generic-esp
board = seeed_xiao_esp32s3
; Use DIO flash mode instead of QIO for QEMU compatibility
; QEMU's ESP32-S3 emulation doesn't support setting the QIE (Quad I/O Enable) bit,
; causing "Failed to set QIE bit" error and boot assertion failure in startup_funcs.c:95
; DIO (Dual I/O) mode works reliably in both hardware and QEMU emulation
board_build.flash_mode = dio
; Set flash size to 4MB to match QEMU configuration (seeed_xiao_esp32s3 default is 8MB)
; Use board_build.flash_size to set the binary header, not board_upload.flash_size
board_build.flash_size = 4MB
; Note: This partition table is for normal builds. QEMU builds use settings from ci/boards.py
; Use huge_app partition table to allow larger debug builds
board_build.partitions = huge_app.csv
build_flags =
    ${env:generic-esp.build_flags}

[env:esp32c6]
extends = env:generic-esp
board = esp32-c6-devkitc-1
build_flags =
  ${env:generic-esp.build_flags}
  -D ARDUINO_USB_CDC_ON_BOOT=1
  -D ARDUINO_USB_MODE=1
  -D CONFIG_PARLIO_TX_ISR_HANDLER_IN_IRAM=1
  -D CONFIG_PARLIO_TX_ISR_CACHE_SAFE=1
  -D PIN_DATA=21
  -D PARLIO_FORCE_LSB_MODE=0
  ; Optional: fix early prints
board_build.flash_mode = dio
board_build.flash_size = 4MB
board_upload.flash_size = 4MB
board_build.partitions = huge_app.csv

[env:esp32c3]
extends = env:generic-esp
board = esp32-c3-devkitm-1
; Use DIO flash mode instead of QIO for QEMU compatibility
; QEMU's ESP32-C3 emulation doesn't support setting the QIE (Quad I/O Enable) bit,
; causing "Failed to set QIE bit" error and boot assertion failure in startup_funcs.c:95
; DIO (Dual I/O) mode works reliably in both hardware and QEMU emulation
board_build.flash_mode = dio
build_flags = ${env:generic-esp.build_flags}

[env:esp32-wroom-32]
extends = env:generic-esp
board = esp32dev
build_flags = ${env:generic-esp.build_flags}

[env:esp32c2]
extends = env:generic-esp
platform = https://github.com/pioarduino/platform-espressif32.git#develop
board = esp32-c2-devkitm-1
custom_sdkconfig = CONFIG_IDF_TARGET="esp32c2"
build_flags = 
  ${env:generic-esp.build_flags}


[env:esp32dev]
extends = env:generic-esp
platform = platformio/espressif32
board = esp32dev
; Use DIO flash mode instead of QIO for QEMU compatibility
; QEMU's ESP32 emulation doesn't support setting the QIE (Quad I/O Enable) bit,
; causing "Failed to set QIE bit" error and boot assertion failure in startup_funcs.c:95
; DIO (Dual I/O) mode works reliably in both hardware and QEMU emulation
board_build.flash_mode = dio
build_flags =
  ${env:generic-esp.build_flags}


[env:teensy40]
platform = teensy
board = teensy40
framework = arduino
build_flags = -D USB_MIDI_SERIAL


[env:sparkfun_xrp_controller]
platform = https://github.com/maxgerhardt/platform-raspberrypi
board = sparkfun_xrp_controller
framework = arduino
build_flags = -fopt-info-all=optimization_report.txt
extra_scripts = pre:ci/ci-flags.py


[platformio]
src_dir = examples/Blink ; default: examples/Validation/Validation.ino (override with PLATFORMIO_SRC_DIR env var)
default_envs = esp32c6
; Enable shared build cache to avoid recompiling FastLED library when switching sketches
; This dramatically speeds up `bash debug <example>` workflow by reusing compiled objects
build_cache_dir = .pio/build_cache

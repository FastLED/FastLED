name: Docker Compiler Platforms

on:
  push:
    paths:
      - 'ci/docker_utils/**'
      - '.github/workflows/docker_compiler_template.yml'
  workflow_dispatch:
    inputs:
      skip_platforms:
        description: 'Skip platform images build'
        type: boolean
        default: false
      delay_minutes:
        description: 'Delay before building platforms (minutes)'
        type: number
        default: 0
  schedule:
    # Full build: monthly at 3:00 AM UTC on the 1st of each month
    # (For daily smart builds, see docker_compiler_smart_build.yml)
    - cron: '0 3 1 * *'

env:
  BASE_IMAGE: niteris/fastled-compiler-base

jobs:
  credentials:
    runs-on: ubuntu-latest
    outputs:
      docker_username: ${{ steps.credentials.outputs.docker_username }}
      docker_password: ${{ steps.credentials.outputs.docker_password }}
      registry_avr: ${{ steps.credentials.outputs.registry_avr }}
      registry_esp_32dev: ${{ steps.credentials.outputs.registry_esp_32dev }}
      registry_esp_32s2: ${{ steps.credentials.outputs.registry_esp_32s2 }}
      registry_esp_32s3: ${{ steps.credentials.outputs.registry_esp_32s3 }}
      registry_esp_8266: ${{ steps.credentials.outputs.registry_esp_8266 }}
      registry_esp_32c2: ${{ steps.credentials.outputs.registry_esp_32c2 }}
      registry_esp_32c3: ${{ steps.credentials.outputs.registry_esp_32c3 }}
      registry_esp_32c5: ${{ steps.credentials.outputs.registry_esp_32c5 }}
      registry_esp_32c6: ${{ steps.credentials.outputs.registry_esp_32c6 }}
      registry_esp_32h2: ${{ steps.credentials.outputs.registry_esp_32h2 }}
      registry_esp_32p4: ${{ steps.credentials.outputs.registry_esp_32p4 }}
      registry_teensy: ${{ steps.credentials.outputs.registry_teensy }}
      registry_stm32_f103c8: ${{ steps.credentials.outputs.registry_stm32_f103c8 }}
      registry_stm32_f411ce: ${{ steps.credentials.outputs.registry_stm32_f411ce }}
      registry_stm32_f103cb: ${{ steps.credentials.outputs.registry_stm32_f103cb }}
      registry_stm32_f103tb: ${{ steps.credentials.outputs.registry_stm32_f103tb }}
      registry_stm32_h747xi: ${{ steps.credentials.outputs.registry_stm32_h747xi }}
      registry_rp: ${{ steps.credentials.outputs.registry_rp }}
      registry_nrf52: ${{ steps.credentials.outputs.registry_nrf52 }}
      registry_sam_3x8e: ${{ steps.credentials.outputs.registry_sam_3x8e }}
    steps:
      - name: Output encoded credentials
        id: credentials
        env:
          docker_username: niteris
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "docker_username=$(echo -n "niteris" | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "docker_password=$(echo $docker_password | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_avr=$(echo -n 'niteris/fastled-compiler-avr' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32dev=$(echo -n 'niteris/fastled-compiler-esp-32dev' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32s2=$(echo -n 'niteris/fastled-compiler-esp-32s2' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32s3=$(echo -n 'niteris/fastled-compiler-esp-32s3' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_8266=$(echo -n 'niteris/fastled-compiler-esp-8266' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32c2=$(echo -n 'niteris/fastled-compiler-esp-32c2' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32c3=$(echo -n 'niteris/fastled-compiler-esp-32c3' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32c5=$(echo -n 'niteris/fastled-compiler-esp-32c5' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32c6=$(echo -n 'niteris/fastled-compiler-esp-32c6' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32h2=$(echo -n 'niteris/fastled-compiler-esp-32h2' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_esp_32p4=$(echo -n 'niteris/fastled-compiler-esp-32p4' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_teensy=$(echo -n 'niteris/fastled-compiler-teensy' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_stm32_f103c8=$(echo -n 'niteris/fastled-compiler-stm32-f103c8' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_stm32_f411ce=$(echo -n 'niteris/fastled-compiler-stm32-f411ce' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_stm32_f103cb=$(echo -n 'niteris/fastled-compiler-stm32-f103cb' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_stm32_f103tb=$(echo -n 'niteris/fastled-compiler-stm32-f103tb' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_stm32_h747xi=$(echo -n 'niteris/fastled-compiler-stm32-h747xi' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_rp=$(echo -n 'niteris/fastled-compiler-rp' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_nrf52=$(echo -n 'niteris/fastled-compiler-nrf52' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT
          echo "registry_sam_3x8e=$(echo -n 'niteris/fastled-compiler-sam-3x8e' | base64 -w0 | base64 -w0)" >> $GITHUB_OUTPUT

  # ============================================================================
  # WAIT FOR BASE IMAGE
  # ============================================================================
  wait-for-base:
    if: github.event.inputs.skip_platforms != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for base image to settle
        run: |
          delay_minutes=${{ github.event.inputs.delay_minutes }}
          if [ -z "$delay_minutes" ] || [ "$delay_minutes" = "null" ]; then
            delay_minutes=10
          fi
          echo "Waiting ${delay_minutes} minutes for base image to settle in registry..."
          sleep $((${delay_minutes} * 60))

  # ============================================================================
  # BUILD JOBS - Each platform builds independently (amd64 + arm64)
  # ============================================================================

  # AVR Platform
  build-avr:
    name: ðŸ”¨ fastled-compiler-avr [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: avr
      platforms: uno,attiny85,attiny88,attiny1616,attiny4313,yun-32u4
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_avr }}

  # ESP32 Platforms - Individual images per board (flat structure)
  build-esp-32dev:
    name: ðŸ”¨ fastled-compiler-esp-32dev [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32dev
      platforms: esp32dev
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32dev }}

  build-esp-32s2:
    name: ðŸ”¨ fastled-compiler-esp-32s2 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32s2
      platforms: esp32s2
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32s2 }}

  build-esp-32s3:
    name: ðŸ”¨ fastled-compiler-esp-32s3 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32s3
      platforms: esp32s3
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32s3 }}

  build-esp-8266:
    name: ðŸ”¨ fastled-compiler-esp-8266 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-8266
      platforms: esp8266
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_8266 }}

  build-esp-32c2:
    name: ðŸ”¨ fastled-compiler-esp-32c2 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32c2
      platforms: esp32c2
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32c2 }}

  build-esp-32c3:
    name: ðŸ”¨ fastled-compiler-esp-32c3 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32c3
      platforms: esp32c3
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32c3 }}

  build-esp-32c5:
    name: ðŸ”¨ fastled-compiler-esp-32c5 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32c5
      platforms: esp32c5
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32c5 }}

  build-esp-32c6:
    name: ðŸ”¨ fastled-compiler-esp-32c6 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32c6
      platforms: esp32c6
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32c6 }}

  build-esp-32h2:
    name: ðŸ”¨ fastled-compiler-esp-32h2 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32h2
      platforms: esp32h2
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32h2 }}

  build-esp-32p4:
    name: ðŸ”¨ fastled-compiler-esp-32p4 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: esp-32p4
      platforms: esp32p4
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_esp_32p4 }}

  # Teensy Platform
  build-teensy:
    name: ðŸ”¨ fastled-compiler-teensy [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: teensy
      platforms: teensy30,teensy31,teensy40,teensy41,teensyLC
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_teensy }}

  # STM32 Platforms - Individual images per board (flat structure)
  build-stm32-f103c8:
    name: ðŸ”¨ fastled-compiler-stm32-f103c8 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: stm32-f103c8
      platforms: stm32f103c8
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_stm32_f103c8 }}

  build-stm32-f411ce:
    name: ðŸ”¨ fastled-compiler-stm32-f411ce [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: stm32-f411ce
      platforms: stm32f411ce
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_stm32_f411ce }}

  build-stm32-f103cb:
    name: ðŸ”¨ fastled-compiler-stm32-f103cb [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: stm32-f103cb
      platforms: stm32f103cb
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_stm32_f103cb }}

  build-stm32-f103tb:
    name: ðŸ”¨ fastled-compiler-stm32-f103tb [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: stm32-f103tb
      platforms: stm32f103tb
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_stm32_f103tb }}

  build-stm32-h747xi:
    name: ðŸ”¨ fastled-compiler-stm32-h747xi [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: stm32-h747xi
      platforms: stm32h747xi
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_stm32_h747xi }}

  # RP Platform
  build-rp:
    name: ðŸ”¨ fastled-compiler-rp [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: rp
      platforms: rp2040,rp2350,rp2350B
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_rp }}

  # NRF52 Platform
  build-nrf52:
    name: ðŸ”¨ fastled-compiler-nrf52 [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: nrf52
      platforms: nrf52840_dk,nrf52_xiaoblesense,adafruit_feather_nrf52840_sense,adafruit_xiaoblesense
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_nrf52 }}

  # SAM Platform
  build-sam-3x8e:
    name: ðŸ”¨ fastled-compiler-sam-3x8e [${{ matrix.arch.platform }}]
    if: github.event.inputs.skip_platforms != 'true'
    needs: [credentials, wait-for-base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - runs_on: ubuntu-24.04
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            platform: linux/arm64
    uses: ./.github/workflows/docker_build_compiler.yml
    with:
      runs_on: ${{ matrix.arch.runs_on }}
      platform: ${{ matrix.arch.platform }}
      dockerfile: Dockerfile.template
      group: sam-3x8e
      platforms: sam3x8e_due
      tag: latest
    secrets:
      env_vars: |
        docker_username=${{ needs.credentials.outputs.docker_username }}
        docker_password=${{ needs.credentials.outputs.docker_password }}
        docker_registry_image=${{ needs.credentials.outputs.registry_sam_3x8e }}

  # ============================================================================
  # MERGE JOBS - Each platform merges independently as soon as its builds complete
  # ============================================================================

  merge-avr:
    name: ðŸ“¦ merge fastled-compiler-avr
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-avr
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: avr
      registry: niteris/fastled-compiler-avr
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32dev:
    name: ðŸ“¦ merge fastled-compiler-esp-32dev
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32dev
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32dev
      registry: niteris/fastled-compiler-esp-32dev
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32s2:
    name: ðŸ“¦ merge fastled-compiler-esp-32s2
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32s2
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32s2
      registry: niteris/fastled-compiler-esp-32s2
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32s3:
    name: ðŸ“¦ merge fastled-compiler-esp-32s3
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32s3
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32s3
      registry: niteris/fastled-compiler-esp-32s3
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-8266:
    name: ðŸ“¦ merge fastled-compiler-esp-8266
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-8266
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-8266
      registry: niteris/fastled-compiler-esp-8266
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32c2:
    name: ðŸ“¦ merge fastled-compiler-esp-32c2
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32c2
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32c2
      registry: niteris/fastled-compiler-esp-32c2
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32c3:
    name: ðŸ“¦ merge fastled-compiler-esp-32c3
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32c3
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32c3
      registry: niteris/fastled-compiler-esp-32c3
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32c5:
    name: ðŸ“¦ merge fastled-compiler-esp-32c5
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32c5
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32c5
      registry: niteris/fastled-compiler-esp-32c5
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32c6:
    name: ðŸ“¦ merge fastled-compiler-esp-32c6
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32c6
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32c6
      registry: niteris/fastled-compiler-esp-32c6
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32h2:
    name: ðŸ“¦ merge fastled-compiler-esp-32h2
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32h2
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32h2
      registry: niteris/fastled-compiler-esp-32h2
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-esp-32p4:
    name: ðŸ“¦ merge fastled-compiler-esp-32p4
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-esp-32p4
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: esp-32p4
      registry: niteris/fastled-compiler-esp-32p4
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-teensy:
    name: ðŸ“¦ merge fastled-compiler-teensy
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-teensy
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: teensy
      registry: niteris/fastled-compiler-teensy
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-stm32-f103c8:
    name: ðŸ“¦ merge fastled-compiler-stm32-f103c8
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-stm32-f103c8
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: stm32-f103c8
      registry: niteris/fastled-compiler-stm32-f103c8
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-stm32-f411ce:
    name: ðŸ“¦ merge fastled-compiler-stm32-f411ce
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-stm32-f411ce
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: stm32-f411ce
      registry: niteris/fastled-compiler-stm32-f411ce
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-stm32-f103cb:
    name: ðŸ“¦ merge fastled-compiler-stm32-f103cb
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-stm32-f103cb
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: stm32-f103cb
      registry: niteris/fastled-compiler-stm32-f103cb
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-stm32-f103tb:
    name: ðŸ“¦ merge fastled-compiler-stm32-f103tb
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-stm32-f103tb
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: stm32-f103tb
      registry: niteris/fastled-compiler-stm32-f103tb
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-stm32-h747xi:
    name: ðŸ“¦ merge fastled-compiler-stm32-h747xi
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-stm32-h747xi
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: stm32-h747xi
      registry: niteris/fastled-compiler-stm32-h747xi
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-rp:
    name: ðŸ“¦ merge fastled-compiler-rp
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-rp
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: rp
      registry: niteris/fastled-compiler-rp
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-nrf52:
    name: ðŸ“¦ merge fastled-compiler-nrf52
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-nrf52
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: nrf52
      registry: niteris/fastled-compiler-nrf52
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

  merge-sam-3x8e:
    name: ðŸ“¦ merge fastled-compiler-sam-3x8e
    if: github.event.inputs.skip_platforms != 'true'
    needs: build-sam-3x8e
    uses: ./.github/workflows/docker_merge_platform.yml
    with:
      group_name: sam-3x8e
      registry: niteris/fastled-compiler-sam-3x8e
      tag: latest
    secrets:
      docker_password: ${{ secrets.DOCKER_PASSWORD }}

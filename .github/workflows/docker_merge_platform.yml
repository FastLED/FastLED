name: Docker Merge Platform

on:
  workflow_call:
    inputs:
      group_name:
        description: 'Platform group name (e.g., avr, esp-32s3)'
        required: true
        type: string
      registry:
        description: 'Docker registry image name (e.g., niteris/fastled-compiler-avr)'
        required: true
        type: string
      tag:
        description: 'Docker image tag'
        required: false
        type: string
        default: 'latest'
    secrets:
      docker_password:
        description: 'Docker Hub password'
        required: true

jobs:
  merge:
    runs-on: ubuntu-24.04
    steps:
      - name: Download digests for ${{ inputs.group_name }}
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-${{ inputs.group_name }}-*
          merge-multiple: true

      - name: Verify digests were downloaded
        run: |
          if [ ! -d /tmp/digests ] || [ -z "$(ls -A /tmp/digests)" ]; then
            echo "ERROR: No digests found for ${{ inputs.group_name }}! Build jobs likely failed."
            exit 1
          fi
          echo "Found digests for ${{ inputs.group_name }}:"
          ls -la /tmp/digests/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.registry }}
          tags: type=raw,value=${{ inputs.tag }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: niteris
          password: ${{ secrets.docker_password }}

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ inputs.registry }}@sha256:%s ' *)

      - name: Inspect image
        run: |
          docker buildx imagetools inspect ${{ inputs.registry }}:${{ inputs.tag }}

      - name: Report success
        run: |
          echo "âœ… Successfully merged and pushed multi-arch image for ${{ inputs.group_name }}"
          echo "   Image: ${{ inputs.registry }}:${{ inputs.tag }}"

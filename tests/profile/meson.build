# ============================================================================
# PROFILE TESTS - Standalone Performance Benchmarking Binaries
# ============================================================================
# Profile tests are NOT unit tests - they're standalone binaries for benchmarking
# performance of specific functions/modules. They don't use doctest and produce
# structured output for AI-driven profile-guided optimization.
#
# Usage:
#   bash profile <function> --docker --iterations 20
#
# Generated by: ci/profile/generate_profile_test.py

# Discover all profile test files (profile_*.cpp)
profile_test_files = run_command(
  'python', '-c',
  '''
import glob
import os
import sys
# Use source directory passed as argument
source_dir = sys.argv[1] if len(sys.argv) > 1 else "."
files = glob.glob(os.path.join(source_dir, "tests/profile/profile_*.cpp"))
if files:
    # Use semicolon as separator to avoid newline issues on Windows
    print(";".join(files))
  ''',
  meson.project_source_root(),
  check: false
).stdout().strip()

if profile_test_files != ''
  foreach profile_file : profile_test_files.split(';')
    # Extract test name from file path: tests/profile/profile_sincos16.cpp â†’ sincos16
    profile_basename = fs.name(profile_file)  # profile_sincos16.cpp
    profile_name = profile_basename.substring(8, -4)  # Remove 'profile_' prefix and '.cpp' suffix

    # Build as standalone executable (no PCH, no doctest, no runner)
    # Uses profile_test_compile_args for readable stack traces (frame pointers + debug symbols)
    # Include project root for tests/profile/profile_result.h
    project_root_dir = include_directories('../..')
    executable('profile_' + profile_name,
      profile_file,
      include_directories: [src_dir, stub_dir, project_root_dir],
      cpp_args: profile_test_compile_args,
      link_args: unit_test_link_args,
      link_with: [fastled_lib],
      install: false,
      build_by_default: false  # Only build when explicitly requested via 'bash profile <function>'
    )
  endforeach

  message('Profile tests found: ' + profile_test_files.split(';').length().to_string() + ' benchmarks')
else
  message('No profile tests found (tests/profile/profile_*.cpp)')
endif

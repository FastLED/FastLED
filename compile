#!/bin/bash
set -e

# Function to find Python executable
find_python() {
    if command -v python3 &> /dev/null; then
        echo "python3"
    elif command -v python &> /dev/null; then
        echo "python"
    else
        echo "Python not found. Please install Python 3."
        exit 1
    fi
}

# Check if uv is installed, if not, install it
if ! command -v uv &> /dev/null; then
    echo "uv command not found. Installing uv..."
    PYTHON=$(find_python)
    $PYTHON -m pip install uv
fi

cd "$(dirname "$0")"

# Skip .venv setup if running inside Docker (system packages are pre-installed)
if [ -z "$FASTLED_DOCKER" ]; then
    # if .venv not found
    if [ ! -d .venv ]; then
        # create virtual environment
        ./install
    fi
fi

show_boards_stmt=""
# if no arguments
if [ $# -eq 0 ]; then
    # show supported boards list
    show_boards_stmt="--supported-boards"
fi

if [ -n "$show_boards_stmt" ]; then
    echo -e "\nSupported boards:\n"
    uv run ci/ci-compile.py $show_boards_stmt | tr ',' '\n' | sed 's/^/  /'
    echo -e "\nUsage: bash compile <board> [--examples example1,example2]\n"
else
    # Auto-detect Docker if not already specified and not running inside Docker
    # Only check if we have a board argument (first positional arg)
    use_docker_flag=""
    if [ -z "$FASTLED_DOCKER" ]; then
        # Check if --docker or --local is already specified
        has_docker_flag=false
        has_local_flag=false
        for arg in "$@"; do
            if [ "$arg" = "--docker" ]; then
                has_docker_flag=true
            elif [ "$arg" = "--local" ]; then
                has_local_flag=true
            fi
        done

        # If neither flag is specified and we have arguments, check Docker availability
        if [ "$has_docker_flag" = false ] && [ "$has_local_flag" = false ] && [ $# -gt 0 ]; then
            # Extract board name (first non-flag argument)
            board_name=""
            for arg in "$@"; do
                # Skip flags (arguments starting with --)
                if [[ ! "$arg" =~ ^-- ]]; then
                    board_name="$arg"
                    break
                fi
            done

            # Check if Docker should be used for this board
            if [ -n "$board_name" ]; then
                docker_check_output=$(uv run python -c "
from ci.util.docker_helper import should_use_docker_for_board
use_docker, reason = should_use_docker_for_board('$board_name', verbose=False)
print('1' if use_docker else '0')
" 2>/dev/null)

                if [ "$docker_check_output" = "1" ]; then
                    use_docker_flag="--docker"
                    echo -e "üê≥ Docker detected and will be used for faster compilation"
                    echo -e "   Use --local to force native compilation instead\n"
                fi
            fi
        fi
    fi

    echo -e "\nRunning uv run ci/ci-compile.py $use_docker_flag $@\n"
    uv run ci/ci-compile.py $use_docker_flag "$@"
fi

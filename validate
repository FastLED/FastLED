#!/usr/bin/env bash

# validate - FastLED Validation Test Wrapper
#
# Runs the Validation.ino sketch with proper --expect and --fail-on patterns
# to catch ISR failures, hardware issues, and test matrix errors.
#
# Usage:
#   bash validate                   # Run with default patterns
#   bash validate --timeout 120     # Override timeout
#   bash validate --skip-lint       # Skip linting phase
#   bash validate --help            # Show help

set -euo pipefail

# Default expect patterns - simplified to essential checks only
DEFAULT_EXPECT=(
    "TX Pin: 0"                      # Hardware setup verification
    "RX Pin: 1"                      # Hardware setup verification
    "DRIVER_ENABLED: PARLIO"         # Parlio driver availability (key driver)
    "VALIDATION_READY: true"         # Test ready indicator
)

# Stop pattern - early exit when test suite completes successfully
# This allows the test to exit early instead of waiting for timeout
STOP_PATTERN="VALIDATION_SUITE_COMPLETE"

# Default fail-on pattern from Validation.ino (lines 78-98)
DEFAULT_FAIL_ON="ERROR"

# Exit-on-error patterns for immediate device failure detection
# ClearCommError indicates device is stuck (ISR hogging CPU, crashed, etc.)
# "register dump" indicates ESP32 panic/crash with register state dump
EXIT_ON_ERROR_PATTERNS=(
    "ClearCommError"
    "register dump"
)

# Help message
show_help() {
    cat <<EOF
FastLED Validation Test Wrapper

Usage:
  bash validate [OPTIONS]

Description:
  Runs the Validation.ino sketch with comprehensive --expect and --fail-on patterns
  to detect ISR failures, hardware issues, and test matrix errors.

  STOP PATTERN: "VALIDATION_SUITE_COMPLETE"
  - Triggers early successful exit when all tests complete
  - Saves time by not waiting for full timeout (typically 60s)
  - Only exits if all --expect patterns have been found
  - The sketch prints this after completing the test matrix

Default Patterns:
  4 --expect patterns covering:
    - Hardware setup (TX/RX pins)
    - Driver availability (PARLIO)
    - Validation ready indicator

  1 --stop pattern:
    - VALIDATION_SUITE_COMPLETE (early exit when tests complete)

  1 --fail-on pattern:
    - ERROR (catches test failures via FL_WARN)

  2 --exit-on-error patterns:
    - ClearCommError (immediate device failure - ISR hang, crash, etc.)
    - register dump (ESP32 panic/crash with register state dump)

Options:
  -h, --help          Show this help message
  --timeout SECONDS   Override default timeout (default: 60s)
  --skip-lint         Skip C++ linting phase (faster iteration)
  --no-expect         Clear default --expect patterns (use custom only)
  --no-fail-on        Clear default --fail-on pattern (use custom only)

Driver Selection (JSON-RPC):
  --parlio            Test only PARLIO driver
  --rmt               Test only RMT driver
  --spi               Test only SPI driver
  --uart              Test only UART driver

  Multiple drivers can be specified: --parlio --rmt
  If no driver flags are specified, all drivers are tested (default)

  Any other options are passed directly to 'bash debug Validation'

Examples:
  bash validate                       # Run with all default patterns (all drivers)
  bash validate --parlio              # Test only PARLIO driver
  bash validate --rmt --spi           # Test only RMT and SPI drivers
  bash validate --timeout 60          # Longer timeout for debugging
  bash validate --skip-lint           # Skip linting for faster iteration
  bash validate --no-expect --expect "CUSTOM PATTERN"  # Custom patterns only

Exit Codes:
  0   Success (all patterns found, no failures)
  1   Failure (missing patterns, ERROR detected, or compilation/upload failed)
  130 User interrupt (Ctrl+C)

See Also:
  - examples/Validation/Validation.ino (lines 78-102) - Pattern documentation
  - examples/Validation/SketchHalt.h (lines 36-52) - Halting state mechanism
  - LOOP.md Section 4 - Testing & Validation Loop Workflow

EOF
}

# Parse arguments
USE_DEFAULT_EXPECT=true
USE_DEFAULT_FAIL_ON=true
EXTRA_ARGS=()
DRIVERS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        --no-expect)
            USE_DEFAULT_EXPECT=false
            shift
            ;;
        --no-fail-on)
            USE_DEFAULT_FAIL_ON=false
            shift
            ;;
        --parlio)
            DRIVERS+=("PARLIO")
            shift
            ;;
        --rmt)
            DRIVERS+=("RMT")
            shift
            ;;
        --spi)
            DRIVERS+=("SPI")
            shift
            ;;
        --uart)
            DRIVERS+=("UART")
            shift
            ;;
        *)
            EXTRA_ARGS+=("$1")
            shift
            ;;
    esac
done

# Build JSON-RPC command if drivers specified
JSON_RPC_CMD=""
if [[ ${#DRIVERS[@]} -gt 0 ]]; then
    # Build JSON array of driver names
    DRIVER_LIST=""
    for driver in "${DRIVERS[@]}"; do
        if [[ -n "$DRIVER_LIST" ]]; then
            DRIVER_LIST+=","
        fi
        DRIVER_LIST+="\"$driver\""
    done

    # Create JSON-RPC command: {"function":"setDrivers","args":["PARLIO","RMT"]}
    JSON_RPC_CMD="{\"function\":\"setDrivers\",\"args\":[$DRIVER_LIST]}"
fi

# Build final command (bypass bash debug wrapper to avoid --check-usage)
CMD=(uv run ci/debug_attached.py Validation)

# Add input-on-trigger to auto-send START when VALIDATION_READY appears
# Format: PATTERN:TEXT[:TIMEOUT] (timeout is optional)
# - Wait for VALIDATION_READY pattern (with 10s timeout)
# - Send START command when pattern found
# - If pattern not found in 10s, fail with "DEVICE APPEARS STUCK" error
# - Without timeout, uses general monitor timeout instead
CMD+=(--input-on-trigger "VALIDATION_READY:START:10")

# Add default --expect patterns unless disabled
if [[ "$USE_DEFAULT_EXPECT" == "true" ]]; then
    for pattern in "${DEFAULT_EXPECT[@]}"; do
        CMD+=(--expect "$pattern")
    done
fi

# Add default --fail-on pattern unless disabled
if [[ "$USE_DEFAULT_FAIL_ON" == "true" ]]; then
    CMD+=(--fail-on "$DEFAULT_FAIL_ON")
fi

# Add stop pattern for early exit when test suite completes
CMD+=(--stop "$STOP_PATTERN")

# Add exit-on-error patterns for immediate device failure detection
for pattern in "${EXIT_ON_ERROR_PATTERNS[@]}"; do
    CMD+=(--exit-on-error "$pattern")
done

# Add JSON-RPC command if drivers specified
if [[ -n "$JSON_RPC_CMD" ]]; then
    CMD+=(--json-rpc "$JSON_RPC_CMD")
fi

# Append any extra arguments
CMD+=("${EXTRA_ARGS[@]}")

# Print command for transparency
echo "Running validation with patterns:"
echo "  Expect: ${#DEFAULT_EXPECT[@]} patterns (use --help to see list)"
echo "  Stop: $STOP_PATTERN (early exit when tests complete)"
echo "  Fail-on: $DEFAULT_FAIL_ON"
echo "  Exit-on-error: ${#EXIT_ON_ERROR_PATTERNS[@]} patterns (immediate failure)"

# Show driver filtering if active
if [[ ${#DRIVERS[@]} -gt 0 ]]; then
    echo "  Driver filter: ${DRIVERS[*]} (via JSON-RPC setDrivers)"
else
    echo "  Driver filter: ALL (default - no filter)"
fi

echo ""
echo "Command: ${CMD[*]}"
echo ""
echo "Note: Using direct backend call (bypasses 'bash debug' wrapper check)"
echo ""

# Execute
exec "${CMD[@]}"
